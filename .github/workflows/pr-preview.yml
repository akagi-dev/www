name: PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Surge
        run: npm install -g surge
      
      - name: Build website for preview
        env:
          PREVIEW_URL: https://pr-${{ github.event.pull_request.number }}-akagi-www.surge.sh
        run: npm run build
      
      - name: Deploy to Surge
        run: |
          surge ./dist https://pr-${{ github.event.pull_request.number }}-akagi-www.surge.sh --token ${{ secrets.SURGE_TOKEN }}
      
      - name: Upload preview artifact (backup)
        uses: actions/upload-artifact@v4
        with:
          name: pr-preview-${{ github.event.pull_request.number }}
          path: ./dist
          retention-days: 7
      
      - name: Comment PR with preview links
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const previewUrl = `https://pr-${prNumber}-akagi-www.surge.sh`;
            
            const message = `## ğŸš€ PR Preview Deployed Successfully!
            
            Your changes are now live and ready for testing:
            
            ### ğŸŒ Preview Links by Language:
            
            | Language | Link | Mobile |
            |----------|------|--------|
            | ğŸ‡¬ğŸ‡§ English | [${previewUrl}/en/](${previewUrl}/en/) | [QR Code ğŸ“±](https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(previewUrl + '/en/')}) |
            | ğŸ‡¯ğŸ‡µ Japanese | [${previewUrl}/ja/](${previewUrl}/ja/) | [QR Code ğŸ“±](https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(previewUrl + '/ja/')}) |
            | ğŸ‡·ğŸ‡º Russian | [${previewUrl}/ru/](${previewUrl}/ru/) | [QR Code ğŸ“±](https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(previewUrl + '/ru/')}) |
            
            ### ğŸ“„ Available Pages:
            - **Home:** [/](${previewUrl}/en/)
            - **Services:** [/services](${previewUrl}/en/services)
            - **Competitions:** [/competitions](${previewUrl}/en/competitions)
            - **Contact:** [/contact](${previewUrl}/en/contact)
            
            ---
            
            <details>
            <summary>ğŸ“¦ Build Artifact (Backup)</summary>
            
            Download artifact: \`pr-preview-${prNumber}\`
            
            To test locally:
            1. Download the artifact from the Actions tab
            2. Extract and serve the \`dist\` folder
            3. Navigate to \`http://localhost:<port>\`
            </details>
            
            ---
            
            *Preview will be automatically cleaned up when PR is closed/merged*`;
            
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('PR Preview Deployed')
            );
            
            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                comment_id: botComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                issue_number: prNumber,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
            }
