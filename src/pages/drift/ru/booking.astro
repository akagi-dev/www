---
import Layout from '@layouts/Layout.astro';
import { useTranslations } from '@i18n/ui';
import ProductGrid from '@components/booking/ProductGrid.astro';

const t = useTranslations('ru');
const locale = 'ru';
---

<Layout>
  <div class="min-h-screen">
    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-akagi-navy to-akagi-teal text-white py-20">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <h1 class="text-4xl md:text-5xl font-bold mb-6 text-akagi-orange">
          {t('drift.booking.title')}
        </h1>
        <p class="text-xl text-akagi-light-blue max-w-3xl">
          {t('drift.booking.description')}
        </p>
      </div>
    </section>

    <!-- Social Media Section -->
    <section class="bg-white py-8">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col items-center md:items-start">
          <h2 class="text-lg font-semibold text-akagi-charcoal mb-4">{t('drift.social.title')}</h2>
          <div class="flex space-x-6">
            <a 
              href="https://www.instagram.com/akagiteam" 
              target="_blank" 
              rel="noopener" 
              class="text-akagi-light-blue hover:text-akagi-orange transition"
              aria-label="Follow us on Instagram"
            >
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path fill-rule="evenodd" d="M12.315 2c2.43 0 2.784.013 3.808.06 1.064.049 1.791.218 2.427.465a4.902 4.902 0 011.772 1.153 4.902 4.902 0 011.153 1.772c.247.636.416 1.363.465 2.427.048 1.067.06 1.407.06 4.123v.08c0 2.643-.012 2.987-.06 4.043-.049 1.064-.218 1.791-.465 2.427a4.902 4.902 0 01-1.153 1.772 4.902 4.902 0 01-1.772 1.153c-.636.247-1.363.416-2.427.465-1.067.048-1.407.06-4.123.06h-.08c-2.643 0-2.987-.012-4.043-.06-1.064-.049-1.791-.218-2.427-.465a4.902 4.902 0 01-1.772-1.153 4.902 4.902 0 01-1.153-1.772c-.247-.636-.416-1.363-.465-2.427-.047-1.024-.06-1.379-.06-3.808v-.63c0-2.43.013-2.784.06-3.808.049-1.064.218-1.791.465-2.427a4.902 4.902 0 011.153-1.772A4.902 4.902 0 015.45 2.525c.636-.247 1.363-.416 2.427-.465C8.901 2.013 9.256 2 11.685 2h.63zm-.081 1.802h-.468c-2.456 0-2.784.011-3.807.058-.975.045-1.504.207-1.857.344-.467.182-.8.398-1.15.748-.35.35-.566.683-.748 1.15-.137.353-.3.882-.344 1.857-.047 1.023-.058 1.351-.058 3.807v.468c0 2.456.011 2.784.058 3.807.045.975.207 1.504.344 1.857.182.466.399.8.748 1.15.35.35.683.566 1.15.748.353.137.882.3 1.857.344 1.054.048 1.37.058 4.041.058h.08c2.597 0 2.917-.01 3.96-.058.976-.045 1.505-.207 1.858-.344.466-.182.8-.398 1.15-.748.35-.35.566-.683.748-1.15.137-.353.3-.882.344-1.857.048-1.055.058-1.37.058-4.041v-.08c0-2.597-.01-2.917-.058-3.96-.045-.976-.207-1.505-.344-1.858a3.097 3.097 0 00-.748-1.15 3.098 3.098 0 00-1.15-.748c-.353-.137-.882-.3-1.857-.344-1.023-.047-1.351-.058-3.807-.058zM12 6.865a5.135 5.135 0 110 10.27 5.135 5.135 0 010-10.27zm0 1.802a3.333 3.333 0 100 6.666 3.333 3.333 0 000-6.666zm5.338-3.205a1.2 1.2 0 110 2.4 1.2 1.2 0 010-2.4z" clip-rule="evenodd" />
              </svg>
            </a>
            <a 
              href="https://www.tiktok.com/@akagi.drift.japan" 
              target="_blank" 
              rel="noopener" 
              class="text-akagi-light-blue hover:text-akagi-orange transition"
              aria-label="Follow us on TikTok"
            >
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z"/>
              </svg>
            </a>
            <a 
              href="https://youtube.com/@akagiracingteam" 
              target="_blank" 
              rel="noopener" 
              class="text-akagi-light-blue hover:text-akagi-orange transition"
              aria-label="Follow us on YouTube"
            >
              <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
              </svg>
            </a>
          </div>
        </div>
      </div>
    </section>

    <!-- Booking Form -->
    <section class="py-16">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="bg-white rounded-lg shadow-lg p-8">
          <form class="space-y-8">
            <!-- Calendar Section -->
            <div class="border-b border-gray-200 pb-6">
              <h2 class="text-2xl font-bold mb-6 text-akagi-charcoal">Выберите дату</h2>
              <p class="text-sm text-gray-600 mb-4">Выберите предпочитаемую дату, чтобы увидеть доступные трассы и автомобили</p>
              <div id="calendar">
                <div class="grid grid-cols-7 gap-2 mb-2">
                  <div class="text-center text-xs font-semibold text-gray-600">Sun</div>
                  <div class="text-center text-xs font-semibold text-gray-600">Mon</div>
                  <div class="text-center text-xs font-semibold text-gray-600">Tue</div>
                  <div class="text-center text-xs font-semibold text-gray-600">Wed</div>
                  <div class="text-center text-xs font-semibold text-gray-600">Thu</div>
                  <div class="text-center text-xs font-semibold text-gray-600">Fri</div>
                  <div class="text-center text-xs font-semibold text-gray-600">Sat</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-2"></div>
                <div class="mt-4 flex gap-4 text-sm">
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-green-200 border border-green-500 rounded"></div>
                    <span>Available</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-gray-200 border border-gray-400 rounded"></div>
                    <span>Unavailable</span>
                  </div>
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 bg-akagi-red text-white border border-akagi-red rounded"></div>
                    <span>Selected</span>
                  </div>
                </div>
              </div>
              <input type="hidden" id="selectedDate" name="selectedDate" required />
            </div>

            <!-- Track Selection -->
            <div class="border-b border-gray-200 pb-6">
              <h2 class="text-2xl font-bold mb-6 text-akagi-charcoal">Выберите трассу</h2>
              <p class="text-sm text-gray-600 mb-4">Сначала выберите дату, чтобы увидеть доступные трассы</p>
              <ProductGrid 
                id="track" 
                label="Выберите трассу"
                required={true}
                locale={locale}
                collectionHandle="drift-tracks"
              />
            </div>

            <!-- Car Selection -->
            <div class="border-b border-gray-200 pb-6">
              <h2 class="text-2xl font-bold mb-6 text-akagi-charcoal">Выберите автомобиль</h2>
              <p class="text-sm text-gray-600 mb-4">Сначала выберите трассу, чтобы увидеть доступные автомобили</p>
              <ProductGrid 
                id="carClass" 
                label="Выберите класс автомобиля"
                required={true}
                locale={locale}
                collectionHandle="drift-cars"
              />
            </div>

            <!-- Time Slot -->
            <div class="border-b border-gray-200 pb-6">
              <h2 class="text-2xl font-bold mb-6 text-akagi-charcoal">Временной слот</h2>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Выберите временной слот *</label>
                <select id="timeSlot" name="timeSlot" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-akagi-red focus:border-akagi-red">
                  <option value="fullday" selected>Полный день (09:00–16:00)</option>
                  <option value="halfday">Полдня (09:00–12:00 или 13:00–16:00)</option>
                </select>
              </div>
            </div>

            <!-- Personal Information -->
            <div class="border-b border-gray-200 pb-6">
              <h2 class="text-2xl font-bold mb-6 text-akagi-charcoal">Личная информация</h2>
              <div class="grid md:grid-cols-2 gap-6">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Полное имя *</label>
                  <input type="text" name="name" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-akagi-red focus:border-akagi-red" />
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-2">Email *</label>
                  <input type="email" name="email" required class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-akagi-red focus:border-akagi-red" />
                </div>
              </div>
            </div>

            <!-- Optional Add-ons -->
            <div class="border-b border-gray-200 pb-6">
              <h2 class="text-2xl font-bold mb-6 text-akagi-charcoal">Optional Add-ons</h2>
              <div class="space-y-3">
                <label class="flex items-center">
                  <input type="checkbox" class="mr-3 h-5 w-5 text-akagi-red border-gray-300 rounded focus:ring-akagi-red" />
                  <span class="text-gray-700">Drift Instruction (¥30,000/hour)</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="mr-3 h-5 w-5 text-akagi-red border-gray-300 rounded focus:ring-akagi-red" />
                  <span class="text-gray-700">Photo/Video Package (¥25,000/session)</span>
                </label>
                <label class="flex items-center">
                  <input type="checkbox" class="mr-3 h-5 w-5 text-akagi-red border-gray-300 rounded focus:ring-akagi-red" />
                  <span class="text-gray-700">Fresh Tire Set (¥40,000)</span>
                </label>
              </div>
            </div>

            <!-- Experience Level -->
            <div class="border-b border-gray-200 pb-6">
              <h2 class="text-2xl font-bold mb-6 text-akagi-charcoal">Experience Level</h2>
              <div class="space-y-3">
                <label class="flex items-center">
                  <input type="radio" name="experience" value="beginner" class="mr-3 h-4 w-4 text-akagi-red border-gray-300 focus:ring-akagi-red" />
                  <span class="text-gray-700">Beginner - First time drifting</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="experience" value="intermediate" class="mr-3 h-4 w-4 text-akagi-red border-gray-300 focus:ring-akagi-red" />
                  <span class="text-gray-700">Intermediate - Some drift experience</span>
                </label>
                <label class="flex items-center">
                  <input type="radio" name="experience" value="advanced" class="mr-3 h-4 w-4 text-akagi-red border-gray-300 focus:ring-akagi-red" />
                  <span class="text-gray-700">Advanced - Experienced drift driver</span>
                </label>
              </div>
            </div>

            <!-- Additional Comments -->
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">Additional Comments or Requests</label>
              <textarea rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-akagi-red focus:border-akagi-red"></textarea>
            </div>

            <!-- Submit Button -->
            <div class="pt-4">
              <button type="submit" id="submitBtn" class="w-full bg-akagi-red hover:bg-akagi-orange text-white font-bold py-4 px-6 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed">
                <span id="submitBtnText">Proceed to Checkout</span>
                <span id="submitBtnLoading" class="hidden">Processing...</span>
              </button>
              <p class="text-sm text-gray-600 mt-4 text-center">
                * You will be redirected to secure checkout to complete your booking
              </p>
            </div>
          </form>
        </div>

        <!-- Important Information -->
        <div class="mt-12 bg-akagi-light-blue bg-opacity-20 p-8 rounded-lg">
          <h2 class="text-2xl font-bold mb-4 text-akagi-charcoal">Important Information</h2>
          <ul class="space-y-2 text-gray-700">
            <li>• Valid driver's license required (international license accepted)</li>
            <li>• Minimum age: 18 years old</li>
            <li>• Safety briefing mandatory before driving</li>
            <li>• Helmet and safety gear provided</li>
            <li>• Cancellation policy: Full refund up to 48 hours before booking</li>
            <li>• Insurance coverage details will be explained during confirmation</li>
          </ul>
        </div>
      </div>
    </section>
  </div>
</Layout>

<script>
  import { fetchCollectionProducts } from '@services/shopify-products';
  import ProductCard from '@components/booking/ProductCard.astro';

  const locale = document.documentElement.lang || 'en';

  // Store all products for filtering
  let allTracks: any[] = [];
  let allCars: any[] = [];

  // Initialize product grids on page load
  async function initializeProductGrids() {
    await Promise.all([
      initializeCarGrid(),
      initializeTrackGrid()
    ]);
    
    // Initialize calendar immediately
    renderCalendar();
  }

  async function initializeCarGrid() {
    const container = document.getElementById('carClass');
    const loading = document.getElementById('carClass-loading');
    const errorDiv = document.getElementById('carClass-error');
    
    if (!container) return;

    try {
      const products = await fetchCollectionProducts('drift-cars', locale);
      allCars = products;
      
      loading?.classList.add('hidden');
      container.classList.remove('hidden');
      
      products.forEach(product => {
        const card = createProductCard(product, 'carClass', true); // Initially disabled
        container.appendChild(card);
      });
    } catch (error) {
      console.error('Failed to load car products:', error);
      loading?.classList.add('hidden');
      errorDiv?.classList.remove('hidden');
    }
  }

  async function initializeTrackGrid() {
    const container = document.getElementById('track');
    const loading = document.getElementById('track-loading');
    const errorDiv = document.getElementById('track-error');
    
    if (!container) return;

    try {
      const products = await fetchCollectionProducts('drift-tracks', locale);
      allTracks = products;
      
      loading?.classList.add('hidden');
      container.classList.remove('hidden');
      
      products.forEach(product => {
        const card = createProductCard(product, 'track', true); // Initially disabled
        container.appendChild(card);
      });
    } catch (error) {
      console.error('Failed to load track products:', error);
      loading?.classList.add('hidden');
      errorDiv?.classList.remove('hidden');
    }
  }

  function createProductCard(product: any, type: string, disabled: boolean = false) {
    const card = document.createElement('div');
    const disabledClasses = disabled ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer hover:shadow-lg hover:scale-105';
    card.className = `product-card border-2 rounded-lg overflow-hidden transition-all duration-200 border-gray-300 hover:border-akagi-orange ${disabledClasses}`;
    card.dataset.productId = product.id;
    card.dataset.handle = product.handle;
    
    card.innerHTML = `
      <div class="aspect-video w-full overflow-hidden bg-gray-100">
        <img
          src="${product.imageUrl}"
          alt="${product.imageAlt}"
          class="w-full h-full object-cover"
          loading="lazy"
        />
      </div>
      <div class="p-4">
        <h3 class="font-semibold text-lg text-akagi-charcoal mb-2 line-clamp-2">
          ${product.title}
        </h3>
        <div class="flex items-center justify-between">
          <p class="text-akagi-red font-bold text-xl">
            ${product.price}
          </p>
          <svg class="w-6 h-6 text-akagi-red hidden selected-icon" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
        </div>
      </div>
    `;
    
    if (!disabled) {
      card.addEventListener('click', () => selectProduct(type, product.handle, card));
    }
    
    return card;
  }

  function selectProduct(type: string, handle: string, selectedCard: HTMLElement) {
    const container = document.getElementById(type);
    const hiddenInput = document.getElementById(`${type}-value`) as HTMLInputElement;
    
    if (!container || !hiddenInput) return;
    
    // Remove selection from all cards in this container
    container.querySelectorAll('.product-card').forEach(card => {
      card.classList.remove('border-akagi-red', 'bg-akagi-light-blue', 'bg-opacity-10', 'shadow-md');
      card.classList.add('border-gray-300');
      const icon = card.querySelector('.selected-icon');
      if (icon) icon.classList.add('hidden');
    });
    
    // Add selection to clicked card
    selectedCard.classList.remove('border-gray-300');
    selectedCard.classList.add('border-akagi-red', 'bg-akagi-light-blue', 'bg-opacity-10', 'shadow-md');
    const icon = selectedCard.querySelector('.selected-icon');
    if (icon) icon.classList.remove('hidden');
    
    // Update hidden input
    hiddenInput.value = handle;
    
    // Update dependent fields
    if (type === 'track') {
      updateCarAvailability();
    }
  }

  // Mock availability data - tracks available on specific dates
  // In production, this would come from an API based on the selected date
  const trackAvailabilityByDate: Record<string, string[]> = {
    // Format: day of month -> available track handles
  };

  // Mock availability data for cars based on track and date
  const mockAvailability: Record<string, Record<string, number[]>> = {
    'na-classics': { chiba: [1, 5, 8, 12, 15, 19, 22, 26, 29], gunma: [2, 6, 9, 13, 16, 20, 23, 27, 30], fuji: [3, 7, 10, 14, 17, 21, 24, 28] },
    'v6-power': { chiba: [2, 6, 9, 13, 16, 20, 23, 27, 30], gunma: [1, 5, 8, 12, 15, 19, 22, 26, 29], fuji: [4, 8, 11, 15, 18, 22, 25, 29] },
    'turbo-legends': { chiba: [3, 7, 10, 14, 17, 21, 24, 28], gunma: [4, 8, 11, 15, 18, 22, 25, 29], fuji: [1, 5, 8, 12, 15, 19, 22, 26, 29] }
  };

  let selectedDate: Date | null = null;
  let currentMonth = new Date();

  function renderCalendar() {
    const calendarDays = document.getElementById('calendarDays');
    if (!calendarDays) return;

    calendarDays.innerHTML = '';
    
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Add empty cells for days before month starts
    for (let i = 0; i < firstDay; i++) {
      const emptyCell = document.createElement('div');
      calendarDays.appendChild(emptyCell);
    }

    // Add day cells - all future dates are available for selection
    for (let day = 1; day <= daysInMonth; day++) {
      const dayDate = new Date(year, month, day);
      const isPast = dayDate < today;
      
      const dayCell = document.createElement('button');
      dayCell.type = 'button';
      dayCell.textContent = day.toString();
      dayCell.className = `p-2 text-sm rounded-md border ${
        isPast 
          ? 'bg-gray-100 text-gray-400 cursor-not-allowed border-gray-300' 
          : 'bg-green-50 border-green-500 hover:bg-green-100 cursor-pointer'
      }`;
      
      if (!isPast) {
        dayCell.addEventListener('click', () => selectDate(year, month, day));
      } else {
        dayCell.disabled = true;
      }
      
      calendarDays.appendChild(dayCell);
    }
  }

  function selectDate(year: number, month: number, day: number) {
    selectedDate = new Date(year, month, day);
    const dateString = selectedDate.toISOString().split('T')[0];
    
    // Update hidden input
    const hiddenInput = document.getElementById('selectedDate') as HTMLInputElement;
    if (hiddenInput) {
      hiddenInput.value = dateString;
    }
    
    // Update visual selection
    const calendarDays = document.getElementById('calendarDays');
    if (calendarDays) {
      const buttons = calendarDays.querySelectorAll('button');
      buttons.forEach(btn => {
        if (btn.textContent === day.toString() && !btn.disabled) {
          btn.className = 'p-2 text-sm rounded-md border bg-akagi-red text-white border-akagi-red font-bold';
        } else if (!btn.disabled) {
          btn.className = 'p-2 text-sm rounded-md border bg-green-50 border-green-500 hover:bg-green-100 cursor-pointer';
        }
      });
    }

    // Update track availability based on selected date
    updateTrackAvailability();
  }

  function updateTrackAvailability() {
    if (!selectedDate) return;

    const container = document.getElementById('track');
    if (!container) return;

    const day = selectedDate.getDate();

    // Get all track cards
    container.querySelectorAll('.product-card').forEach(card => {
      const handle = (card as HTMLElement).dataset.handle;
      
      // For demo: tracks chiba, gunma, fuji are available on different days
      // This simulates checking availability from an API
      let isAvailable = true; // In production, check against API
      
      // Simple logic: different tracks available on different days (for demo)
      if (handle === 'chiba') {
        isAvailable = day % 3 === 1;
      } else if (handle === 'gunma') {
        isAvailable = day % 3 === 2;
      } else if (handle === 'fuji') {
        isAvailable = day % 3 === 0;
      }

      if (isAvailable) {
        card.classList.remove('opacity-50', 'cursor-not-allowed');
        card.classList.add('cursor-pointer', 'hover:shadow-lg', 'hover:scale-105');
        const handle = (card as HTMLElement).dataset.handle;
        if (handle) {
          (card as HTMLElement).onclick = () => selectProduct('track', handle, card as HTMLElement);
        }
      } else {
        card.classList.add('opacity-50', 'cursor-not-allowed');
        card.classList.remove('cursor-pointer', 'hover:shadow-lg', 'hover:scale-105');
        (card as HTMLElement).onclick = null;
      }
    });
  }

  function updateCarAvailability() {
    const trackInput = document.getElementById('track-value') as HTMLInputElement;
    if (!trackInput?.value || !selectedDate) return;

    const container = document.getElementById('carClass');
    if (!container) return;

    const track = trackInput.value;
    const day = selectedDate.getDate();

    // Get all car cards
    container.querySelectorAll('.product-card').forEach(card => {
      const handle = (card as HTMLElement).dataset.handle;
      
      // Check if car is available for selected track and date
      const availableDays = mockAvailability[handle || '']?.[track] || [];
      const isAvailable = availableDays.includes(day);

      if (isAvailable) {
        card.classList.remove('opacity-50', 'cursor-not-allowed');
        card.classList.add('cursor-pointer', 'hover:shadow-lg', 'hover:scale-105');
        const handle = (card as HTMLElement).dataset.handle;
        if (handle) {
          (card as HTMLElement).onclick = () => selectProduct('carClass', handle, card as HTMLElement);
        }
      } else {
        card.classList.add('opacity-50', 'cursor-not-allowed');
        card.classList.remove('cursor-pointer', 'hover:shadow-lg', 'hover:scale-105');
        (card as HTMLElement).onclick = null;
      }
    });
  }

  // Form submission handler
  document.querySelector('form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;
    const submitBtnText = document.getElementById('submitBtnText');
    const submitBtnLoading = document.getElementById('submitBtnLoading');
    
    if (!selectedDate) {
      alert('Please select a date from the calendar');
      return;
    }

    const trackInput = document.getElementById('track-value') as HTMLInputElement;
    const carClassInput = document.getElementById('carClass-value') as HTMLInputElement;
    
    if (!trackInput?.value) {
      alert('Please select a track');
      return;
    }
    
    if (!carClassInput?.value) {
      alert('Please select a car class');
      return;
    }
    
    // Disable submit button and show loading state
    if (submitBtn) submitBtn.disabled = true;
    submitBtnText?.classList.add('hidden');
    submitBtnLoading?.classList.remove('hidden');
    
    try {
      // Gather form data
      const formData = new FormData(e.target as HTMLFormElement);
      const bookingData = {
        selectedDate: selectedDate.toISOString().split('T')[0],
        track: trackInput.value,
        carClass: carClassInput.value,
        timeSlot: (document.getElementById('timeSlot') as HTMLSelectElement)?.value,
        personalInfo: {
          name: formData.get('name'),
          email: formData.get('email')
        }
      };
      
      // In production, this would create a Shopify checkout
      await simulateShopifyCheckout(bookingData);
      
      // Redirect would happen here in production
      alert('Booking data prepared! In production, you would be redirected to Shopify checkout.');
      console.log('Booking data:', bookingData);
      
    } catch (error) {
      console.error('Booking error:', error);
      alert('An error occurred. Please try again.');
    } finally {
      // Re-enable submit button
      if (submitBtn) submitBtn.disabled = false;
      submitBtnText?.classList.remove('hidden');
      submitBtnLoading?.classList.add('hidden');
    }
  });

  // Simulate Shopify API call
  async function simulateShopifyCheckout(bookingData: any) {
    return new Promise((resolve) => {
      setTimeout(resolve, 1000);
    });
  }

  // Initialize grids and calendar on page load
  window.addEventListener('DOMContentLoaded', () => {
    initializeProductGrids();
  });
</script>
